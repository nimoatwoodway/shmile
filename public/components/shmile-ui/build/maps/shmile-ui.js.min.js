{"version":3,"sources":["shmile-ui.js"],"names":["CameraUtils","snap","idx","cheeseCb","p","zoomFrame","modalMessage","Config","ready_delay","scale4x6","maxw","maxh","s0","s1","w","h","photo_margin","window_width","$","window","width","window_height","height","overlay_delay","next_delay","cheese_delay","flash_duration","nice_delay","between_snap_delay","is_mobile","AppState","this","reset","prototype","current_frame_idx","zoomed","location","reload","ShmileStateMachine","photoView","socket","appState","config","buttonView","self","fsm","StateMachine","create","initial","events","name","from","to","callbacks","onconnected","animate","onenterready","resetState","onleaveready","onenterwaiting_for_photo","e","flashStart","emit","onphoto_saved","f","t","data","flashEnd","updatePhotoSet","web_url","setTimeout","photo_updated","onphoto_updated","finish_set","continue_partial_set","onenterreview_composited","showOverlay","next_set","onleavereview_composited","console","log","bind","unbind","slideInNext","onchangestate","SocketProxy","fakeSocket","_","extend","Backbone","Events","lateInitialize","on","evt","cb","msg","trigger","SocketLayer","io","proxy","init","connect","register","connected","filename","photo_saved","document","click","PhotoView","View","id","initialize","state","canvas","Raphael","frames","set","images","all","overlayImage","photoBorder","compositeDim","frameDim","compositeOrigin","compositeCenter","render","x","y","r","rect","attr","fill","push","frame_x","frame_y","frame","img","image","clone","translate","o","hide","toString","ret","length","join","img_src","view","imgEl","frameEl","src","opacity","show","afterShowPhoto","dir","translation","onfinish","frameX","frameW","frameY","frameH","centerX","centerY","animSpeed","dx","dy","scaleFactor","scale","flashEffect","duration","undefined","remove","text","persistTime","animateSpeed","fontSize","sideLength","fill-opacity","stroke-color","txt","font-size","font-weight","hideOverlay","ButtonView","ui_button_pressed","ready","socketProxy","bv","ssm","layer"],"mappings":"AAGC,GAAIA,aAAc,YAUnBA,aAAYC,KAAO,SAASC,EAAKC,GAC/BC,EAAEC,UAAUH,EAAK,MAEjBE,EAAEE,aAAa,UAAWC,OAAOC,YAAa,IAAK,WACjDJ,EAAEE,aAAa,IAAK,IAAM,IAAK,WAC7BF,EAAEE,aAAa,IAAK,IAAM,IAAM,WAC9BF,EAAEE,aAAa,IAAK,IAAM,IAAK,WAC7BH,aAWVH,YAAYS,SAAW,SAASC,EAAMC,GAClC,GAAIC,GAAK,IACLC,EAAKH,EAAKC,CAGd,OAAIC,IAAMC,GACEC,EAAU,EAAPH,EAAS,EAAGI,EAAGJ,IAElBG,EAAGJ,EAAMK,EAAU,EAAPL,EAAS,GAIrC,IAAIH,SACFS,aAAc,GACdC,aAAcC,EAAEC,QAAQC,QACxBC,cAAeH,EAAEC,QAAQG,SAAW,GACpCC,cAAe,IACfC,WAAY,IACZC,aAAc,IACdC,eAAgB,IAChBlB,YAAa,IACbmB,WAAY,IAMZC,mBAAoB,IAGpBC,WAAW,GAMTC,SAAW,WACbC,KAAKC,QAGPF,UAASG,UAAUD,MAAQ,WACzBD,KAAKG,kBAAoB,EACzBH,KAAKI,OAAS,KAGdC,SAASC,SAwBX,IAAIC,oBAAqB,SAAUC,EAAWC,EAAQC,EAAUC,EAAQC,GACpEZ,KAAKQ,UAAYA,EACjBR,KAAKS,OAASA,EACdT,KAAKU,SAAWA,EAChBV,KAAKW,OAASA,EACdX,KAAKY,WAAaA,CAElB,IAAIC,GAAOb,IAEXA,MAAKc,IAAMC,aAAaC,QACpBC,QAAS,UACTC,SACKC,KAAM,YAAaC,KAAM,UAAWC,GAAI,UACxCF,KAAM,oBAAqBC,KAAM,QAASC,GAAI,sBAC9CF,KAAM,cAAeC,KAAM,oBAAqBC,GAAI,iBACpDF,KAAM,gBAAiBC,KAAM,eAAgBC,GAAI,eACjDF,KAAM,uBAAwBC,KAAM,aAAcC,GAAI,sBACtDF,KAAM,aAAcC,KAAM,aAAcC,GAAI,sBAC5CF,KAAM,WAAYC,KAAM,oBAAqBC,GAAI,UAEtDC,WACIC,YAAa,WACTV,EAAKL,UAAUgB,QAAQ,KAAM,eAIjCC,aAAc,WACVZ,EAAKL,UAAUkB,cAEnBC,aAAc,aAEdC,yBAA0B,SAAUC,GAChCzD,SAAW,WACPyC,EAAKL,UAAUjC,aAAa,UAAWsC,EAAKF,OAAOjB,cACnDmB,EAAKL,UAAUsB,aACfjB,EAAKJ,OAAOsB,KAAK,QAAQ,IAE7B9D,YAAYC,KAAK2C,EAAKH,SAASP,kBAAmB/B,WAEtD4D,cAAe,SAAUH,EAAGI,EAAGC,EAAGC,GAG9BtB,EAAKL,UAAU4B,WACfvB,EAAKL,UAAU6B,eAAeF,EAAKG,QAASzB,EAAKH,SAASP,kBAAmB,WACzEoC,WAAW,WACP1B,EAAKC,IAAI0B,iBACV3B,EAAKF,OAAOd,uBAGvB4C,gBAAiB,SAAUZ,EAAGI,EAAGC,GAC7BrB,EAAKL,UAAU4B,WAEwB,GAAnCvB,EAAKH,SAASP,kBACdU,EAAKC,IAAI4B,cAIT7B,EAAKH,SAASP,mBAAqBU,EAAKH,SAASP,kBAAoB,GAAK,EAC1EU,EAAKC,IAAI6B,yBAGjBC,yBAA0B,SAAUf,EAAGI,EAAGC,GACtCrB,EAAKJ,OAAOsB,KAAK,aACjBlB,EAAKL,UAAUqC,aAAY,GAC3BN,WAAW,WACP1B,EAAKC,IAAIgC,YACVjC,EAAKF,OAAOlB,aAEnBsD,yBAA0B,SAAUlB,EAAGI,EAAGC,GAEtCrB,EAAKL,UAAUgB,QAAQ,OACvBwB,QAAQC,IAAI,YAEZ9D,EAAEC,QAAQ8D,KAAK,QAAS,WACpBrC,EAAKJ,OAAOsB,KAAK,SAAS,GAC1B5C,EAAEa,MAAMmD,OAAO,WAGnBtC,EAAKL,UAAUjC,aAAa,oDAAqD,IAAO,IAAK,WAEzFyE,QAAQC,IAAI,mBACZ9D,EAAEC,QAAQ+D,OAAO,SACjBtC,EAAKL,UAAU4C,iBAGvBC,cAAe,SAAUxB,EAAGI,EAAGC,GAC3Bc,QAAQC,IAAI,sBAAwBpB,EAAI,yBAA2BI,EAAI,OAASC,QAW5FoB,YAAc,WAChBtD,KAAKS,OAAS,KACdT,KAAKuD,cACLC,EAAEC,OAAOzD,KAAKuD,WAAYG,SAASC,QAGrCL,aAAYpD,UAAU0D,eAAiB,SAASnD,GAC9CT,KAAKS,OAASA,GAGhB6C,YAAYpD,UAAU2D,GAAK,SAASC,EAAKC,GACvC,MAAoB,QAAhB/D,KAAKS,QACPuC,QAAQC,IAAI,iDACZjD,MAAKuD,WAAWM,GAAGC,EAAKC,QAG1B/D,MAAKS,OAAOoD,GAAGC,EAAKC,IAGtBT,YAAYpD,UAAU6B,KAAO,SAASiC,EAAK7B,GACzC,MAAoB,QAAhBnC,KAAKS,QACPuC,QAAQC,IAAI,mDACZjD,MAAKuD,WAAWU,QAAQD,EAAK,WAC3BhB,QAAQC,IAAId,UAIhBnC,MAAKS,OAAOsB,KAAKiC,EAAK7B,GAQxB,IAAI+B,aAAc,SAASC,EAAIC,GAC7BpE,KAAKmE,GAAKA,EACVnE,KAAKoE,MAAQA,EAOfF,aAAYhE,UAAUmE,KAAO,WAC3B,IACErE,KAAKS,OAAST,KAAKmE,GAAGG,QAAQ,KAC9BtE,KAAKoE,MAAMR,eAAe5D,KAAKS,QAC/B,MAAMoB,GACNmB,QAAQC,IAAI,yCAA2CpB,GAEzD,MAAO7B,OAMTkE,YAAYhE,UAAUqE,SAAW,SAASzD,GACxCd,KAAKc,IAAMA,CACX,IAAID,GAAOb,IAEXA,MAAKoE,MAAMP,GAAG,UAAW,SAAS1B,GAChCa,QAAQC,IAAI,wBAA0Bd,KAGxCnC,KAAKoE,MAAMP,GAAG,UAAW,WACvBb,QAAQC,IAAI,iBACZpC,EAAKC,IAAI0D,cAGXxE,KAAKoE,MAAMP,GAAG,iBAAkB,WAC9Bb,QAAQC,IAAI,wBAIdjD,KAAKoE,MAAMP,GAAG,cAAe,SAAS1B,GACpCa,QAAQC,IAAI,oBAAsBd,EAAKsC,UACvC5D,EAAKC,IAAI4D,YAAYvC,KAGvBnC,KAAKoE,MAAMP,GAAG,QAAS,SAAS1B,GAC9Ba,QAAQC,IAAI,qBACZ9D,EAAEwF,UAAUC,UAIhB,IAAIC,WAAYnB,SAASoB,KAAKrB,QAC1BsB,GAAI,YAEJC,WAAY,SAAUrE,EAAQsE,GAC1BjF,KAAKW,OAASA,EACdX,KAAKkF,OAAS,GAAIC,SAAQ,WAAYnF,KAAKW,OAAOzB,aAAcc,KAAKW,OAAOrB,eAC5EU,KAAKoF,OAASpF,KAAKkF,OAAOG,MAC1BrF,KAAKsF,OAAStF,KAAKkF,OAAOG,MAC1BrF,KAAKuF,IAAMvF,KAAKkF,OAAOG,MACvBrF,KAAKwF,aAAe,KACpBxF,KAAKyF,YAAc,EACnBzF,KAAK0F,aAAe,KACpB1F,KAAK2F,SAAW,KAChB3F,KAAK4F,gBAAkB,KACvB5F,KAAK6F,gBAAkB,KACvB7F,KAAKiF,MAAQA,GAGjBa,OAAQ,WACJ,GAAI/G,GAAIiB,KAAKW,OAAOzB,aAAec,KAAKW,OAAO1B,aAC3CD,EAAIgB,KAAKW,OAAOrB,cAAgBU,KAAKW,OAAO1B,YAChDe,MAAK0F,aAAezH,YAAYS,SAASK,EAAGC,GAC5CgB,KAAK4F,iBACDG,GAAI/F,KAAKW,OAAOzB,aAAec,KAAK0F,aAAa3G,GAAK,EACtDiH,GAAIhG,KAAKW,OAAOrB,cAAgBU,KAAK0F,aAAa1G,GAAK,GAE3DgB,KAAK6F,iBACDE,EAAG/F,KAAK4F,gBAAgBG,EAAK/F,KAAK0F,aAAa3G,EAAI,EACnDiH,EAAGhG,KAAK4F,gBAAgBI,EAAKhG,KAAK0F,aAAa1G,EAAI,EAEvD,IAAIiH,GAAIjG,KAAKkF,OAAOgB,KAAKlG,KAAK4F,gBAAgBG,EAAG/F,KAAK4F,gBAAgBI,EAAGhG,KAAK0F,aAAa3G,EAAGiB,KAAK0F,aAAa1G,EAEhHiH,GAAEE,MAAMC,KAAQ,UAEhBpG,KAAKuF,IAAIc,KAAKJ,GAGdjG,KAAKyF,YAAczF,KAAK0F,aAAa3G,EAAI,EAGzC,IAAIuH,GAAUtG,KAAK4F,gBAAgBG,EAAI/F,KAAKyF,YACxCc,EAAUvG,KAAK4F,gBAAgBI,EAAIhG,KAAKyF,WAC5CzF,MAAK2F,UACD5G,GAAIiB,KAAK0F,aAAa3G,EAAK,EAAIiB,KAAKyF,aAAgB,EACpDzG,GAAIgB,KAAK0F,aAAa1G,EAAK,EAAIgB,KAAKyF,aAAgB,EAExD,IAAIe,GAAQxG,KAAKkF,OAAOgB,KAAKI,EAASC,EAASvG,KAAK2F,SAAS5G,EAAGiB,KAAK2F,SAAS3G,EAC9EwH,GAAML,MAAMC,KAAQ,SACpB,IAAIK,GAAMzG,KAAKkF,OAAOwB,MAAM,KAAMJ,EAASC,EAASvG,KAAK2F,SAAS5G,EAAGiB,KAAK2F,SAAS3G,EAEnFgB,MAAKsF,OAAOe,KAAKI,GACjBzG,KAAKoF,OAAOiB,KAAKG,GACjBxG,KAAKuF,IAAIc,KAAKI,GACdzG,KAAKuF,IAAIc,KAAKG,GAEdA,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,UAAU5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,YAAa,GACpDgB,EAAIG,UAAU5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,YAAa,GAClDzF,KAAKoF,OAAOiB,KAAKG,GACjBxG,KAAKsF,OAAOe,KAAKI,GACjBzG,KAAKuF,IAAIc,KAAKG,GACdxG,KAAKuF,IAAIc,KAAKI,GAEdD,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,YAAY5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,aAAczF,KAAK2F,SAAS3G,EAAIgB,KAAKyF,aAC9EgB,EAAIG,YAAY5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,aAAczF,KAAK2F,SAAS3G,EAAIgB,KAAKyF,aAC5EzF,KAAKoF,OAAOiB,KAAKG,GACjBxG,KAAKsF,OAAOe,KAAKI,GACjBzG,KAAKuF,IAAIc,KAAKG,GACdxG,KAAKuF,IAAIc,KAAKI,GAEdD,EAAQA,EAAMG,QACdF,EAAMA,EAAIE,QACVH,EAAMI,UAAU5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,YAAa,GACpDgB,EAAIG,UAAU5G,KAAK2F,SAAS5G,EAAIiB,KAAKyF,YAAa,GAClDzF,KAAKoF,OAAOiB,KAAKG,GACjBxG,KAAKsF,OAAOe,KAAKI,GACjBzG,KAAKuF,IAAIc,KAAKG,GACdxG,KAAKuF,IAAIc,KAAKI,EAGd,IAAII,GAAI7G,KAAKkF,OAAOwB,MAChB,sBACA1G,KAAK4F,gBAAgBG,EACrB/F,KAAK4F,gBAAgBI,EACrBhG,KAAK0F,aAAa3G,EAClBiB,KAAK0F,aAAa1G,EACtBgB,MAAKuF,IAAIc,KAAKQ,GACd7G,KAAKwF,aAAeqB,EAGpB7G,KAAKuF,IAAIuB,OACT9G,KAAKuF,IAAIqB,WAAW5G,KAAKW,OAAOzB,aAAc,IAGlD6H,SAAU,WAMN,MALAC,QACAA,IAAIX,KAAK,sBAAwBrG,KAAKuF,IAAI0B,QAC1CD,IAAIX,KAAK,yBAA2BrG,KAAKoF,OAAO6B,QAChDD,IAAIX,KAAK,uBAAyBrG,KAAKuF,IAAI,GAAGY,KAAK,SAAW,IAAMnG,KAAKuF,IAAI,GAAGY,KAAK,WACrFa,IAAIX,KAAK,mBAAqBrG,KAAK2F,SAAS5G,EAAI,IAAMiB,KAAK2F,SAAS3G,GAC7DgI,IAAIE,KAAK,OAYpB7E,eAAgB,SAAU8E,EAAShJ,EAAK4F,GACpC,GAAIqD,GAAOpH,KACPqH,EAAQD,EAAK9B,OAAOnH,GACpBmJ,EAAUF,EAAKhC,OAAOjH,EAE1BkJ,GAAMlB,MAAMoB,IAAOJ,EAASK,QAAW,IACvCH,EAAMI,MAEN,IAAIC,GAAiB,WAEjBJ,EAAQR,OACRzI,EAAEC,UAAUH,EAAK,MAAO4F,GAE5BsD,GAAM7F,SAASgG,QAAW,GAAI,IAAKE,IAQvClG,QAAS,SAAUmG,EAAK5D,GACR,OAAR4D,GACA3H,KAAKuF,IAAIkC,OACTzH,KAAKsF,OAAOwB,OACZ9G,KAAKwF,aAAasB,OAClB9G,KAAKuF,IAAI/D,SACLoG,YAAe5H,KAAKW,OAAOzB,aAAe,MAC3C,IAAM,KAAM6E,IACA,QAAR4D,GACP3H,KAAKuF,IAAI/D,SACLoG,YAAe5H,KAAKW,OAAOzB,aAAe,MAC3C,IAAM,KAAM6E,IAkBvBzF,UAAW,SAAUH,EAAKwJ,EAAKE,GAC3B,GAAIT,GAAOpH,KAGPwG,GAFYxG,KAAKuF,IAAIpH,GAEb6B,KAAKoF,OAAOjH,IACpB2J,EAAStB,EAAML,KAAK,KACpB4B,EAASvB,EAAML,KAAK,SACpB6B,EAASxB,EAAML,KAAK,KACpB8B,EAASzB,EAAML,KAAK,UACpB+B,EAAUJ,EAASC,EAAS,EAC5BI,EAAUH,EAASC,EAAS,EAE5BG,EAAY,IAGZC,EAAKrI,KAAK6F,gBAAgBE,EAAImC,EAC9BI,EAAKtI,KAAK6F,gBAAgBG,EAAImC,EAC9BI,EAAcvI,KAAK0F,aAAa3G,EAAIiB,KAAK2F,SAAS5G,CAE1C,SAAR4I,GAAiB3H,KAAKiF,MAAM7E,QAC5BmI,EAAc,EACdF,GAAMrI,KAAKiF,MAAM7E,OAAOiI,GACxBC,GAAMtI,KAAKiF,MAAM7E,OAAOkI,GACxBlB,EAAK7B,IAAI/D,SACLgH,OAAU,EAAG,EAAGpB,EAAKvB,gBAAgBE,EAAGqB,EAAKvB,gBAAgBG,GAAGkB,KAAK,MACtEkB,EAAW,SAAU,WACpBhB,EAAK7B,IAAI/D,SACLoG,YAAeS,EAAK,IAAMC,GAC3BF,EAAW,KAAMP,KAGxB7H,KAAKiF,MAAM7E,OAAS,MACL,QAARuH,IACPP,EAAK7B,IAAI/D,SACLoG,YAAeS,EAAK,IAAMC,GAC3BF,EAAW,KAAM,WAChBhB,EAAK7B,IAAI/D,SACLgH,OAAUD,EAAaA,EAAanB,EAAKvB,gBAAgBE,EAAGqB,EAAKvB,gBAAgBG,GAAGkB,KAAK,MAC1FkB,EAAW,SAAUP,KAG5B7H,KAAKiF,MAAM7E,QACPiI,GAAIA,EACJC,GAAIA,EACJC,YAAaA,KAQzBnF,YAAa,WACTpD,KAAK0B,aACL1B,KAAKzB,aAAa,SAClByB,KAAKuF,IAAIuB,OACT9G,KAAKuF,IAAIqB,UAAsC,GAA3B5G,KAAKW,OAAOzB,aAAkB,GAClDc,KAAKwB,QAAQ,KAAM,WACfrC,EAAEwF,UAAUzB,KAAK,QAAS,WACtB/D,EAAEwF,UAAUV,QAAQ,qBACpB9E,EAAEa,MAAMmD,OAAO,cAQ3BzB,WAAY,WACR1B,KAAKiF,MAAMhF,SAMfwI,YAAa,SAAUC,GACFC,SAAbD,IACAA,EAAW,IAEf,IAAIxC,GAAOlG,KAAKkF,OAAOgB,KAAK,EAAG,EAAGlG,KAAKW,OAAOzB,aAAcc,KAAKW,OAAOrB,cACxE4G,GAAKC,MAAMC,KAAQ,QAASoB,QAAW,IACvCtB,EAAK1E,SAASgG,QAAW,GAAIkB,EAAU,IAAK,WACxCxC,EAAK1E,SAASgG,QAAW,GAAIkB,EAAU,KACvCxC,EAAK0C,YAIb9G,WAAY,SAAU4G,GACDC,SAAbD,IACAA,EAAW,KAEf1I,KAAKkG,KAAOlG,KAAKkF,OAAOgB,KAAK,EAAG,EAAGlG,KAAKW,OAAOzB,aAAcc,KAAKW,OAAOrB,eACzEU,KAAKkG,KAAKC,MAAMC,KAAQ,QAASoB,QAAW,IAC5CxH,KAAKkG,KAAK1E,SAASgG,QAAW,GAAIkB,EAAU,MAGhDtG,SAAU,SAAUsG,GACCC,SAAbD,IACAA,EAAW,IAEf,IAAI7H,GAAOb,IACXA,MAAKkG,KAAK1E,SAASgG,QAAW,GAAIkB,EAAU,IAAK,WAC7C7H,EAAK+H,YAObrK,aAAc,SAAUsK,EAAMC,EAAaC,EAAchF,EAAIiF,GACzD,GAAqBL,SAAjBI,EACA,GAAIA,GAAe,GAEvB,IAAoBJ,SAAhBG,EACA,GAAIA,GAAc,GAGtB,IAAIG,GAAyC,GAA5BjJ,KAAKW,OAAOrB,cACzByG,GAAK/F,KAAKW,OAAOzB,aAAe+J,GAAc,EAC9CjD,GAAKhG,KAAKW,OAAOrB,cAAgB2J,GAAc,EAC/C1D,EAAMvF,KAAKkF,OAAOG,MAClBY,EAAIjG,KAAKkF,OAAOgB,KAAKH,EAAGC,EACxBiD,EACAA,EACA,GACJhD,GAAEE,MACEC,KAAQ,OACR8C,eAAgB,GAChBC,eAAgB,UAEpB5D,EAAIc,KAAKJ,EACT,IAAImD,GAAMpJ,KAAKkF,OAAO2D,KAAK9C,EAAIkD,EAAa,EAAGjD,EAAIiD,EAAa,EAAGJ,EACnEO,GAAIjD,MACAC,KAAQ,QACRiD,YAAa,KACbC,cAAe,SAEnB/D,EAAIc,KAAK+C,GACT7D,EAAIY,MAAMqB,QAAW,IACrBjC,EAAI/D,SACAgG,QAAW,EACXgB,MAAS,UACTa,YAAa,MACdN,EAAc,IAGTxG,YAAW,SAAUgD,GAEzB6D,EAAIR,SACJ3C,EAAE2C,SACE7E,GAAIA,KACT+E,EAAavD,IAOpB1C,YAAa,SAAUrB,GACnBxB,KAAKwF,aAAaiC,OACdjG,GAEAxB,KAAKwF,aAAahE,SAASgG,QAAW,GAAIxH,KAAKW,OAAOnB,gBAO9D+J,YAAa,SAAU/H,GACnB,GAAI4F,GAAOpH,IACPwB,GACAxB,KAAKwF,aAAahE,SAASgG,QAAW,GAAIxH,KAAKW,OAAOnB,cAAe,WACjE4H,EAAK5B,aAAasB,SAGtB9G,KAAKwF,aAAasB,UAK1B0C,WAAa,SAAU1I,GACvBd,KAAKc,IAAMA,EAGf0I,YAAWtJ,UAAU4F,OAAS,WAC1B,GAAIjF,GAAOb,IAoBXb,GAAEwF,UAAUzB,KAAK,QAAS,WACtB/D,EAAEwF,UAAUV,QAAQ,qBACpB9E,EAAEa,MAAMmD,OAAO,WAGnBhE,EAAEwF,UAAUzB,KAAK,oBAAqB,WAClCF,QAAQC,IAAI,yBACZpC,EAAKC,IAAI2I,uBASjBtK,EAAEC,QAAQsK,MAAM,WACd,GAAIC,GAAc,GAAIrG,aAClB5C,EAAW,GAAIX,SAEnBX,QAAO+E,GAAK/E,OAAO+E,IAAMwE,OAEzBvJ,OAAOf,EAAI,GAAIwG,WAAUzF,OAAOZ,OAAQkC,GACxCkJ,GAAK,GAAIJ,WAET,IAAIK,GAAM,GAAItJ,oBAAmBnB,OAAOf,EAAGsL,EAAajJ,EAAUtB,OAAOZ,OAAQoL,GAEjFA,IAAG9I,IAAM+I,EAAI/I,GAEb,IAAIgJ,GAAQ,GAAI5F,aAAY9E,OAAO+E,GAAIwF,EACvCG,GAAMzF,OACNyF,EAAMvF,SAASsF,EAAI/I,KAEnB1B,OAAOuK,YAAcA,EAErBC,GAAG9D,SACHzH,EAAEyH","file":"../js/shmile-ui.js","sourcesContent":["/**\n * A class of utility methods.\n */\n var CameraUtils = function() {};\n\n/**\n * Play the snap effect.\n * @param {Integer} idx\n *   The frame index to place the updated image.\n * @param {Function} cheeseCB\n *   Code to execute after \"Cheese\" is displayed.\n *   Typically, this wraps the command to fire the shutter.\n */\nCameraUtils.snap = function(idx, cheeseCb) {\n  p.zoomFrame(idx, 'in');\n  // These guys need to be promises.\n  p.modalMessage('Bereit?', Config.ready_delay, 200, function() {\n    p.modalMessage(\"3\", 1000, 200, function() {\n      p.modalMessage(\"2\", 1000, 200,  function() {\n        p.modalMessage(\"1\", 1000, 200, function() {\n          cheeseCb();\n        });\n      });\n    });\n  });\n}\n\n/**\n * Given a max w and h bounds, return the dimensions\n * of the largest 4x6 rect that will fit within.\n */\nCameraUtils.scale4x6 = function(maxw, maxh) {\n    var s0 = 6/4; // width / height\n    var s1 = maxw/maxh;\n\n    // Then the width is longer. Use the shorter side (height)\n    if (s0 <= s1) {\n        return {w: maxh * 6/4, h: maxh};\n    } else {\n        return {w: maxw, h: maxw * 4/6}\n    }\n}\n\nvar Config = {\n  photo_margin: 50, // Margin for the composite photo per side\n  window_width: $(window).width(),\n  window_height: $(window).height() - 10,\n  overlay_delay: 2000,\n  next_delay: 10000,\n  cheese_delay: 400,\n  flash_duration: 1000,\n  ready_delay: 2000,\n  nice_delay: 5000,\n\n  // The amount of time we should pause between each frame shutter\n  // I tend to bump this up when 1) photobooth participants want more\n  // time to review their photos between shots, and 2) when I'm shooting\n  // with external flash and the flash needs more time to recharge.\n  between_snap_delay: 1000,\n\n  // For usability enhancements on iPad, set this to \"true\"\n  is_mobile: false\n}\n\n/**\n * Describes the current state of the UI.\n */\nvar AppState = function() {\n  this.reset();\n};\n\nAppState.prototype.reset = function() {\n  this.current_frame_idx = 0;\n  this.zoomed = null;\n\n  //reload page for performance\n  location.reload();\n}\n\n/*\n * STATE MACHINE DEFINITION\n * Keep track of app state and logic.\n *\n * + loading\n *   - connected() -> ready\n * + ready\n *   - ui_button_pressed() (DOM button click) -> waiting_for_photo\n * + waiting_for_photo\n *   - photo_saved() -> review_photo\n * + review_photo\n *   - photo_updated() -> next_photo\n * + next_photo\n *   - continue_partial_set() -> waiting_for_photo\n *   - finish_set() -> ready\n *\n * @param [PhotoView]\n * @param [Socket]            The initialized Socket\n * @param [AppState] appState Global initialized state\n * @param [Config] config     The configuration options passed to the app\n */\nvar ShmileStateMachine = function (photoView, socket, appState, config, buttonView) {\n    this.photoView = photoView;\n    this.socket = socket;\n    this.appState = appState;\n    this.config = config;\n    this.buttonView = buttonView\n\n    var self = this;\n\n    this.fsm = StateMachine.create({\n        initial: 'loading',\n        events: [\n            {name: 'connected', from: 'loading', to: 'ready'},\n            {name: 'ui_button_pressed', from: 'ready', to: 'waiting_for_photo'},\n            {name: 'photo_saved', from: 'waiting_for_photo', to: 'review_photo'},\n            {name: 'photo_updated', from: 'review_photo', to: 'next_photo'},\n            {name: 'continue_partial_set', from: 'next_photo', to: 'waiting_for_photo'},\n            {name: 'finish_set', from: 'next_photo', to: 'review_composited'},\n            {name: 'next_set', from: 'review_composited', to: 'ready'}\n        ],\n        callbacks: {\n            onconnected: function () {\n                self.photoView.animate('in', function () {\n                    //self.buttonView.fadeIn();\n                });\n            },\n            onenterready: function () {\n                self.photoView.resetState();\n            },\n            onleaveready: function () {\n            },\n            onenterwaiting_for_photo: function (e) {\n                cheeseCb = function () {\n                    self.photoView.modalMessage('Cheese!', self.config.cheese_delay);\n                    self.photoView.flashStart();\n                    self.socket.emit('snap', true);\n                }\n                CameraUtils.snap(self.appState.current_frame_idx, cheeseCb);\n            },\n            onphoto_saved: function (e, f, t, data) {\n                // update UI\n                // By the time we get here, the idx has already been updated!!\n                self.photoView.flashEnd();\n                self.photoView.updatePhotoSet(data.web_url, self.appState.current_frame_idx, function () {\n                    setTimeout(function () {\n                        self.fsm.photo_updated();\n                    }, self.config.between_snap_delay)\n                });\n            },\n            onphoto_updated: function (e, f, t) {\n                self.photoView.flashEnd();\n                // We're done with the full set.\n                if (self.appState.current_frame_idx == 3) {\n                    self.fsm.finish_set();\n                }\n                // Move the frame index up to the next frame to update.\n                else {\n                    self.appState.current_frame_idx = (self.appState.current_frame_idx + 1) % 4\n                    self.fsm.continue_partial_set();\n                }\n            },\n            onenterreview_composited: function (e, f, t) {\n                self.socket.emit('composite');\n                self.photoView.showOverlay(true);\n                setTimeout(function () {\n                    self.fsm.next_set()\n                }, self.config.next_delay);\n            },\n            onleavereview_composited: function (e, f, t) {\n                // Clean up\n                self.photoView.animate('out');\n                console.log('Drucken?');\n\n                $(window).bind('click', function () {\n                    self.socket.emit('print', true);\n                    $(this).unbind('click');\n                });\n\n                self.photoView.modalMessage('Sehr schön! Drücke erneut um das Bild zu drucken!', 10000, 200, function () {\n                    //remove click handler\n                    console.log('delete listener');\n                    $(window).unbind('click');\n                    self.photoView.slideInNext();\n                });\n            },\n            onchangestate: function (e, f, t) {\n                console.log('fsm received event ' + e + ', changing state from ' + f + ' to ' + t)\n            }\n        }\n    });\n}\n\n/**\n * Proxy object that allows the late initialization of the socket, if one\n * exists at all. In instances where we never initialize the socket, we allow\n * for a fake Socket object using a Backbone Event channel.\n */\nvar SocketProxy = function() {\n  this.socket = null;\n  this.fakeSocket = {};\n  _.extend(this.fakeSocket, Backbone.Events)\n}\n\nSocketProxy.prototype.lateInitialize = function(socket) {\n  this.socket = socket;\n}\n\nSocketProxy.prototype.on = function(evt, cb) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'on' delegating to fakeSocket\")\n    this.fakeSocket.on(evt, cb)\n    return\n  }\n  this.socket.on(evt, cb);\n}\n\nSocketProxy.prototype.emit = function(msg, data) {\n  if (this.socket === null) {\n    console.log(\"SocketProxy 'emit' delegating to fakeSocket\")\n    this.fakeSocket.trigger(msg, function() {\n      console.log(data)\n    });\n    return\n  }\n  this.socket.emit(msg, data);\n}\n\n/**\n * Responsible for initializing the connection to socket.io.\n * @param io [Socket]\n * @param fsm [StateMachine]\n */\nvar SocketLayer = function(io, proxy) {\n  this.io = io;\n  this.proxy = proxy;\n}\n\n/**\n * Attempt a connection to socket.io server.\n * If this fails, will no-op and silently continue.\n */\nSocketLayer.prototype.init = function() {\n  try {\n    this.socket = this.io.connect(\"/\");\n    this.proxy.lateInitialize(this.socket);\n  } catch(e) {\n    console.log(\"Error initializing socket connection: \" + e);\n  }\n  return this;\n}\n\n/**\n * Register bindings and callbacks.\n */\nSocketLayer.prototype.register = function(fsm) {\n  this.fsm = fsm;\n  var self = this;\n\n  this.proxy.on('message', function(data) {\n    console.log('message evt: data is:' + data);\n  });\n\n  this.proxy.on('connect', function() {\n    console.log('connected evt');\n    self.fsm.connected();\n  });\n\n  this.proxy.on('camera_snapped', function() {\n    console.log('camera_snapped evt');\n    //fsm.camera_snapped();\n  })\n\n  this.proxy.on('photo_saved', function(data) {\n    console.log('photo_saved evt: ' + data.filename);\n    self.fsm.photo_saved(data);\n  });\n\n  this.proxy.on('click', function(data) {\n    console.log('click event fired');\n    $(document).click();\n  });\n}\n\nvar PhotoView = Backbone.View.extend({\n    id: \"#viewport\",\n\n    initialize: function (config, state) {\n        this.config = config;\n        this.canvas = new Raphael('viewport', this.config.window_width, this.config.window_height);\n        this.frames = this.canvas.set(); // List of SVG black rects\n        this.images = this.canvas.set(); // List of SVG images\n        this.all = this.canvas.set();\n        this.overlayImage = null;\n        this.photoBorder = 0;\n        this.compositeDim = null;\n        this.frameDim = null;\n        this.compositeOrigin = null;\n        this.compositeCenter = null;\n        this.state = state;\n    },\n\n    render: function () {\n        var w = this.config.window_width - this.config.photo_margin;\n        var h = this.config.window_height - this.config.photo_margin;\n        this.compositeDim = CameraUtils.scale4x6(w, h);\n        this.compositeOrigin = {\n            x: (this.config.window_width - this.compositeDim.w) / 2,\n            y: (this.config.window_height - this.compositeDim.h) / 2\n        };\n        this.compositeCenter = {\n            x: this.compositeOrigin.x + (this.compositeDim.w / 2),\n            y: this.compositeOrigin.y + (this.compositeDim.h / 2)\n        }\n        var r = this.canvas.rect(this.compositeOrigin.x, this.compositeOrigin.y, this.compositeDim.w, this.compositeDim.h);\n\n        r.attr({'fill': 'white'});\n\n        this.all.push(r);\n\n        // Scale the photo padding too\n        this.photoBorder = this.compositeDim.w / 50;\n\n        //upper x\n        var frame_x = this.compositeOrigin.x + this.photoBorder;\n        var frame_y = this.compositeOrigin.y + this.photoBorder;\n        this.frameDim = {\n            w: (this.compositeDim.w - (3 * this.photoBorder)) / 2,\n            h: (this.compositeDim.h - (3 * this.photoBorder)) / 2\n        };\n        var frame = this.canvas.rect(frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n        frame.attr({'fill': 'black'});\n        var img = this.canvas.image(null, frame_x, frame_y, this.frameDim.w, this.frameDim.h);\n\n        this.images.push(img);\n        this.frames.push(frame);\n        this.all.push(img);\n        this.all.push(frame);\n\n        frame = frame.clone();\n        img = img.clone();\n        frame.translate(this.frameDim.w + this.photoBorder, 0);\n        img.translate(this.frameDim.w + this.photoBorder, 0);\n        this.frames.push(frame);\n        this.images.push(img);\n        this.all.push(frame);\n        this.all.push(img);\n\n        frame = frame.clone();\n        img = img.clone();\n        frame.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n        img.translate(-(this.frameDim.w + this.photoBorder), this.frameDim.h + this.photoBorder);\n        this.frames.push(frame);\n        this.images.push(img);\n        this.all.push(frame);\n        this.all.push(img);\n\n        frame = frame.clone();\n        img = img.clone();\n        frame.translate(this.frameDim.w + this.photoBorder, 0);\n        img.translate(this.frameDim.w + this.photoBorder, 0);\n        this.frames.push(frame);\n        this.images.push(img);\n        this.all.push(frame);\n        this.all.push(img);\n\n        // Draw the PNG logo overlay.\n        var o = this.canvas.image(\n            '/images/overlay.png',\n            this.compositeOrigin.x,\n            this.compositeOrigin.y,\n            this.compositeDim.w,\n            this.compositeDim.h);\n        this.all.push(o);\n        this.overlayImage = o;\n\n        // Hide everything and move out of sight.\n        this.all.hide();\n        this.all.translate(-this.config.window_width, 0);\n    },\n\n    toString: function () {\n        ret = [];\n        ret.push(\"Size of 'all' set: \" + this.all.length);\n        ret.push(\"Size of 'frames' set: \" + this.frames.length);\n        ret.push(\"Composite photo is: \" + this.all[0].attr('width') + 'x' + this.all[0].attr('height'));\n        ret.push(\"Frame photo is: \" + this.frameDim.w + 'x' + this.frameDim.h);\n        return ret.join('\\n');\n    },\n\n    /**\n     * Updates the image at the set location.\n     * @param {String} img_src\n     *   The URL of the image resource the browser should fetch and display\n     * @param {Integer} idx\n     *   Index of frame to update\n     * @param cb\n     *   The callback to be executed when the UI has finished updating and zooming out.\n     */\n    updatePhotoSet: function (img_src, idx, cb) {\n        var view = this;\n        var imgEl = view.images[idx];\n        var frameEl = view.frames[idx];\n\n        imgEl.attr({'src': img_src, 'opacity': 0});\n        imgEl.show();\n\n        var afterShowPhoto = function () {\n            // We've found and revealed the photo, now hide the old black rect and zoom out\n            frameEl.hide();\n            p.zoomFrame(idx, 'out', cb);\n        }\n        imgEl.animate({'opacity': 1}, 200, afterShowPhoto);\n    },\n\n    /**\n     * For in: assume the view has been rendered and reset to initial state and moved out of sight.\n     * Slide in the composite image.\n     * For out: assume the composite image is centered. Move out of sight and hide.\n     */\n    animate: function (dir, cb) {\n        if (dir === 'in') {\n            this.all.show();\n            this.images.hide();\n            this.overlayImage.hide();\n            this.all.animate({\n                'translation': this.config.window_width + \",0\"\n            }, 1000, \"<>\", cb);\n        } else if (dir === 'out') {\n            this.all.animate({\n                'translation': this.config.window_width + \",0\"\n            }, 1000, \"<>\", cb);\n        }\n    },\n\n    /**\n     * zoomFrame zooms into the indicated frame.\n     * Call it once to zoom in, call it again to zoom out.\n     *\n     * @param idx Frame index\n     *   Expect zoomFrame(1) to be matched immediately by zoomFrame(1)\n     * frame: 0 (upper left), 1 (upper-right), 2 (lower-left), 3 (lower-right)\n     * @param dir 'in' or 'out'\n     *   Zoom in or out\n     * @param onfinish\n     *   Callback executed when the animation is finished.\n     *\n     * Depends on the presence of the .zoomed object to store zoom info.\n     */\n    zoomFrame: function (idx, dir, onfinish) {\n        var view = this;\n        var composite = this.all[idx];\n\n        var frame = this.frames[idx];\n        var frameX = frame.attr('x');\n        var frameW = frame.attr('width');\n        var frameY = frame.attr('y');\n        var frameH = frame.attr('height');\n        var centerX = frameX + frameW / 2;\n        var centerY = frameY + frameH / 2;\n\n        var animSpeed = 700;\n\n        // delta to translate to.\n        var dx = this.compositeCenter.x - centerX;\n        var dy = this.compositeCenter.y - centerY;\n        var scaleFactor = this.compositeDim.w / this.frameDim.w;\n\n        if (dir === \"out\" && this.state.zoomed) {\n            scaleFactor = 1;\n            dx = -this.state.zoomed.dx;\n            dy = -this.state.zoomed.dy;\n            view.all.animate({\n                'scale': [1, 1, view.compositeCenter.x, view.compositeCenter.y].join(','),\n            }, animSpeed, 'bounce', function () {\n                view.all.animate({\n                    'translation': dx + ',' + dy\n                }, animSpeed, '<>', onfinish)\n            });\n            // Clear the zoom data.\n            this.state.zoomed = null;\n        } else if (dir !== \"out\") {\n            view.all.animate({\n                'translation': dx + ',' + dy\n            }, animSpeed, '<>', function () {\n                view.all.animate({\n                    'scale': [scaleFactor, scaleFactor, view.compositeCenter.x, view.compositeCenter.y].join(','),\n                }, animSpeed, 'bounce', onfinish)\n            });\n            // Store the zoom data for next zoom.\n            this.state.zoomed = {\n                dx: dx,\n                dy: dy,\n                scaleFactor: scaleFactor\n            };\n        }\n    },\n\n    /**\n     * Reset visibility, location of composite image for next round.\n     */\n    slideInNext: function () {\n        this.resetState();\n        this.modalMessage('Next!');\n        this.all.hide();\n        this.all.translate(-this.config.window_width * 2, 0);\n        this.animate('in', function () {\n            $(document).bind('click', function () {\n                $(document).trigger('ui_button_pressed');\n                $(this).unbind('click');\n            });\n        });\n    },\n\n    /**\n     * Resets the state variables.\n     */\n    resetState: function () {\n        this.state.reset();\n    },\n\n    /**\n     * Faux camera flash\n     */\n    flashEffect: function (duration) {\n        if (duration === undefined) {\n            duration = 200;\n        }\n        var rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n        rect.attr({'fill': 'white', 'opacity': 0});\n        rect.animate({'opacity': 1}, duration, \">\", function () {\n            rect.animate({'opacity': 0}, duration, \"<\");\n            rect.remove();\n        })\n    },\n\n    flashStart: function (duration) {\n        if (duration === undefined) {\n            duration = 200;\n        }\n        this.rect = this.canvas.rect(0, 0, this.config.window_width, this.config.window_height);\n        this.rect.attr({'fill': 'white', 'opacity': 0});\n        this.rect.animate({'opacity': 1}, duration, \">\")\n    },\n\n    flashEnd: function (duration) {\n        if (duration === undefined) {\n            duration = 200;\n        }\n        var self = this;\n        this.rect.animate({'opacity': 0}, duration, \"<\", function () {\n            self.remove();\n        });\n    },\n\n    /**\n     * Draws a modal with some text.\n     */\n    modalMessage: function (text, persistTime, animateSpeed, cb, fontSize) {\n        if (animateSpeed === undefined) {\n            var animateSpeed = 200;\n        }\n        if (persistTime === undefined) {\n            var persistTime = 500;\n        }\n\n        var sideLength = this.config.window_height * 0.3;\n        var x = (this.config.window_width - sideLength) / 2;\n        var y = (this.config.window_height - sideLength) / 2;\n        var all = this.canvas.set();\n        var r = this.canvas.rect(x, y,\n            sideLength,\n            sideLength,\n            15);\n        r.attr({\n            'fill': '#222',\n            'fill-opacity': 0.7,\n            'stroke-color': 'white'\n        });\n        all.push(r);\n        var txt = this.canvas.text(x + sideLength / 2, y + sideLength / 2, text);\n        txt.attr({\n            'fill': 'white',\n            'font-size': '50',\n            'font-weight': 'bold'\n        });\n        all.push(txt);\n        all.attr({'opacity': 0});\n        all.animate({\n            'opacity': 1,\n            'scale': '1.5,1.5',\n            'font-size': '70'\n        }, animateSpeed, '>');\n\n        // Timer to delete self nodes.\n        var t = setTimeout(function (all) {\n            // Delete nodes\n            txt.remove();\n            r.remove();\n            if (cb) cb();\n        }, persistTime, all);\n    },\n\n    /**\n     * Applies the final image overlay to the composite image.\n     * This will usually contain the wedding logo: 24-bit transparent PNG\n     */\n    showOverlay: function (animate) {\n        this.overlayImage.show();\n        if (animate) {\n            //this.overlayImage.attr({'opacity':0});\n            this.overlayImage.animate({'opacity': 1}, this.config.overlay_delay);\n        }\n    },\n\n    /**\n     * Removes the overlay\n     */\n    hideOverlay: function (animate) {\n        var view = this;\n        if (animate) {\n            this.overlayImage.animate({'opacity': 0}, this.config.overlay_delay, function () {\n                view.overlayImage.hide();\n            });\n        } else {\n            this.overlayImage.hide();\n        }\n    }\n});\n\nvar ButtonView = function (fsm) {\n    this.fsm = fsm;\n}\n\nButtonView.prototype.render = function () {\n    var self = this;\n    // init code\n    //this.startButton = $('button#start-button');\n    //var buttonX = (Config.window_width - this.startButton.outerWidth())/2;\n    //var buttonY = (Config.window_height - this.startButton.outerHeight())/2;\n\n    //this.startButton.hide();\n\n    // Position the start button in the center\n    //this.startButton.css({'top': buttonY, 'left': buttonX});\n\n    //var buttonTriggerEvt = Config.is_mobile ? \"touchend\" : \"click\";\n\n    /*this.startButton.bind(buttonTriggerEvt, function(e) {\n      var button = $(e.currentTarget);\n      button.fadeOut(1000);\n      $(document).trigger('ui_button_pressed');\n    });*/\n\n    //trigger on mouse click\n    $(document).bind('click', function () {\n        $(document).trigger('ui_button_pressed');\n        $(this).unbind('click');\n    });\n\n    $(document).bind('ui_button_pressed', function () {\n        console.log('ui_button_pressed evt');\n        self.fsm.ui_button_pressed();\n    });\n}\n// ButtonView.prototype.fadeIn = function() {\n//   this.startButton.fadeIn();\n// }\n\n\n// Everything required to set up the app.\n$(window).ready(function() {\n  var socketProxy = new SocketProxy();\n  var appState = new AppState();\n\n  window.io = window.io || undefined;\n\n  window.p = new PhotoView(window.Config, appState);\n  bv = new ButtonView();\n\n  var ssm = new ShmileStateMachine(window.p, socketProxy, appState, window.Config, bv)\n\n  bv.fsm = ssm.fsm\n\n  var layer = new SocketLayer(window.io, socketProxy)\n  layer.init();\n  layer.register(ssm.fsm);\n\n  window.socketProxy = socketProxy\n\n  bv.render();\n  p.render();\n});\n"]}